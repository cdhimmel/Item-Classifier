---
title: "Sales Predictor"
author: "Christopher Himmel"
date: "January 16, 2016"
output: word_document
---

#Introduction

A valuable exercise in retail is being able to predict sales of your inventory.  Predictive models can be used to do this, building a relationship betwen given information that you have currently and future sales.  Current information includes previous sales and Item attributes, of which there are many.

The many item attributes are recorded when the new SKU's are entered by hand one by one, or loaded as a group by uploading them and processing them into the system.  They are stored in the Inventory Master file (INVMST).  Sales history is loaded as stores sell inventory, quantities and prices are uploaded from the Point-Of-Sale and accumulated into a few buckets in the Inventory Balance files (INVBAL and INVCBL). 

The data used for this exercise is directly pulled out of JDA's Merchandise Management System, which runs on IBM's System-i.  The information is downloaded from INVMST, INVCBL and INVBAL (limited to only ISTORE between 1001 and 1003).

The following is the R code and results from this exercise.

#Set up R environment

```{r, message=FALSE}
#Needed<-c("dplyr", "tm", "wordcloud", "SnowballC", "corrplot", "rpart", "rattle", "randomForest", "tidyr", "ggplot2")
#install.packages(Needed, dependencies=TRUE)
library(tm)
library(dplyr)
library(wordcloud)
library(SnowballC)
library(corrplot)
library(rpart)
library(rattle)
library(randomForest)
library(tidyr)
library(ggplot2)
setwd("C:/Users/Christopher Himmel/Dropbox/Deep Learning/SlideRule Foundations/Capstone")
```

#Upload data pulled out of MMS

Load and view Item Master (INVMST):

```{r}
Item_Master = read.csv("INVMST - Item Master.csv")
#View(Item_Master)
#summary(Item_Master)
```

Load and view Chain Level Inventory Balance file (INVCBL):

```{r}
Inv_Bal_Chain = read.csv("INVCBL - Chain Level Inventory Balance Data.csv")
#View(Inv_Bal_Chain)
#summary(Inv_Bal_Chain)
```

Load and view Store Level Inventory Balance file, filtered for Niquea'D stores (INVBAL):

```{r}
Inv_Bal_Store = read.csv("INVBAL - Store Level Inventory Balance Data - Niquea'D.csv")
#View(Inv_Bal_Store)
#summary(Inv_Bal_Store)
```

#Format data set

Create chain level field with combined regular sales and advertised sales:

```{r}
Inv_Bal_Chain_mut <-
	Inv_Bal_Chain %>%
	mutate(chn_sales=CBRSUY+CBASUY)
```

Create total Niquea'D summarized sales with combined regular sales and advertised sales:

```{r}
Inv_Bal_Store_sum <- 
	Inv_Bal_Store %>%
	group_by(INUMBR) %>%
	summarise(nd_sales=sum(IBRSUY+IBASUY),
	          IBHAND_sum=sum(IBHAND),
	          IBWKCR_sum=sum(IBWKCR),
	          IBWK01_sum=sum(IBWK01),
	          IBWK02_sum=sum(IBWK02),
	          IBWK03_sum=sum(IBWK03),
	          IBWK04_sum=sum(IBWK04),
	          IBWK05_sum=sum(IBWK05),
	          IBWK06_sum=sum(IBWK06),
	          IBWK07_sum=sum(IBWK07),
	          IBWK08_sum=sum(IBWK08))
Inv_Bal_Store_sum <- subset(Inv_Bal_Store_sum, IBHAND_sum!=0 | nd_sales!=0)
```

Combine two new sales numbers into one file by SKU:

```{r}
Inv_values <-
	Inv_Bal_Store_sum %>%
	left_join(Inv_Bal_Chain_mut, by="INUMBR") %>%
	select(INUMBR,nd_sales,chn_sales,IBHAND_sum,IBWKCR_sum,IBWK01_sum,IBWK02_sum,IBWK03_sum,IBWK04_sum,
	       IBWK05_sum,IBWK06_sum,IBWK07_sum,IBWK08_sum)
```

Combine SKU, sales data into one file for analysis:

```{r}
Inv_final <-
	Inv_values %>%
	left_join(Item_Master, by="INUMBR")
```

#Break descriptions down for learning

Extract word list from description:

```{r}
word_list <- paste(Inv_final$IDESCR, collapse=" ")
word_list_vector <- VectorSource(word_list)
rm(word_list)
word_list_corpus <- Corpus(word_list_vector)
rm(word_list_vector)

word_list_corpus <- tm_map(word_list_corpus, content_transformer(tolower))
word_list_corpus <- tm_map(word_list_corpus, removePunctuation)
word_list_corpus <- tm_map(word_list_corpus, stripWhitespace)
word_list_corpus <- tm_map(word_list_corpus, removeNumbers)
word_list_corpus <- tm_map(word_list_corpus, removeWords, stopwords("english"))
word_list_corpus <- tm_map(word_list_corpus, stemDocument)

tdm<-TermDocumentMatrix(word_list_corpus)
rm(word_list_corpus)
tdm2<-as.matrix(tdm)
rm(tdm)
tdm3<-as.data.frame(tdm2)
rm(tdm2)
colnames(tdm3)<-c("count")
tdm4<-subset(tdm3,tdm3$count>132)
rm(tdm3)
top_words_list<-rownames(tdm4)
rm(tdm4)
```

Generate training vector:

```{r}
description_list <- Inv_final$IDESCR
description_list_vector <- VectorSource(description_list)
rm(description_list)
description_list_corpus <- Corpus(description_list_vector)
rm(description_list_vector)

description_list_corpus <- tm_map(description_list_corpus, content_transformer(tolower))
description_list_corpus <- tm_map(description_list_corpus, removePunctuation)
description_list_corpus <- tm_map(description_list_corpus, stripWhitespace)
description_list_corpus <- tm_map(description_list_corpus, removeNumbers)
description_list_corpus <- tm_map(description_list_corpus, removeWords, stopwords("english"))
description_list_corpus <- tm_map(description_list_corpus, stemDocument)

dtm_dataset<-DocumentTermMatrix(description_list_corpus)
rm(description_list_corpus)
dtm_dataset2<-as.matrix(dtm_dataset)
rm(dtm_dataset)
dtm_match<-match(top_words_list,colnames(dtm_dataset2))
dtm_dataset_top<-dtm_dataset2[,dtm_match]
rm(dtm_dataset2)
dtm_dataset_topdf<-as.data.frame(dtm_dataset_top)
rm(dtm_dataset_top)
colnames(dtm_dataset_topdf)<-paste("w", colnames(dtm_dataset_topdf), sep="_")
```

Add word values to training set:

```{r}
Inv_final$rownumber<-c(1:nrow(Inv_final))
dtm_dataset_topdf$rownumber<-rownames(dtm_dataset_topdf)
Inv_final<-merge(Inv_final,dtm_dataset_topdf,by="rownumber")
```

#Test each attribute for significant amount of data

Visualize each column of data:

```{r}
# IDESCR - factors of descriptions
# ICHECK - all Zeros
barplot(table(Inv_final$ICHECK),main="ICHECK")
# IDSCCD - minimal values
barplot(table(Inv_final$IDSCCD),main="IDSCCD")
# ISORT - factors of descriptions
# ISTYLN - all NA's
# ASNUM - distributed values
barplot(table(Inv_final$ASNUM),main="ASNUM")
# IVNDPN - empty
barplot(table(Inv_final$IVNDPN),main="IVNDPN")
# IMFGR - empty
barplot(table(Inv_final$IMFGR),main="IMFGR")
# IMFGNO - some values
barplot(table(Inv_final$IMFGNO),main="IMFGNO")
# IDEPT - use
barplot(table(Inv_final$IDEPT),main="IDEPT")
# ISDEPT - use
barplot(table(Inv_final$ISDEPT),main="ISDEPT")
# ICLAS - use
barplot(table(Inv_final$ICLAS),main="ICLAS")
# ISCLAS - use
barplot(table(Inv_final$ISCLAS),main="ISCLAS")
# BYRNUM - convert NA's to 0
Inv_final$BYRNUM[is.na(Inv_final$BYRNUM)]<-0
barplot(table(Inv_final$BYRNUM),main="BYRNUM")
# IASPAC - empty
barplot(table(Inv_final$IASPAC),main="IASPAC")
# IADVYN - empty
barplot(table(Inv_final$IADVYN),main="IADVYN")
# IBUYCD - mostly empty
barplot(table(Inv_final$IBUYCD),main="IBUYCD")
# ISET - empty
barplot(table(Inv_final$ISET),main="ISET")
# IWARNT - mostly empty
barplot(table(Inv_final$IWARNT),main="IWARNT")
# IPRMPT - mostly empty
barplot(table(Inv_final$IPRMPT),main="IPRMPT")
# IPRVNT - mostly empty
barplot(table(Inv_final$IPRVNT),main="IPRVNT")
# ITKTTR - convert NA's to 0
Inv_final$ITKTTR[is.na(Inv_final$ITKTTR)]<-0
barplot(table(Inv_final$ITKTTR),main="ITKTTR")
# ITKTTA - mostly empty
barplot(table(Inv_final$ITKTTA),main="ITKTTA")
# ITKTN
barplot(table(Inv_final$ITKTN),main="ITKTN")
# ILBLTR - convert NA's to 0
Inv_final$ILBLTR[is.na(Inv_final$ILBLTR)]<-0
barplot(table(Inv_final$ILBLTR),main="ILBLTR")
# ILBLTA - empty
barplot(table(Inv_final$ILBLTA),main="ILBLTA")
# IFINLN
barplot(table(Inv_final$IFINLN),main="IFINLN")
# IPROFL - mostly empty
barplot(table(Inv_final$IPROFL),main="IPROFL")
# IMODUL - mostly empty
barplot(table(Inv_final$IMODUL),main="IMODUL")
# ISTYPE
barplot(table(Inv_final$ISTYPE),main="ISTYPE")
# ISCOLR - mostly empty
barplot(table(Inv_final$ISCOLR),main="ISCOLR")
# ISSIZE - mostly empty
barplot(table(Inv_final$ISSIZE),main="ISSIZE")
# IHAZCD - all NA's
# MCHNUM - all NA's
# ISUBST - empty
barplot(table(Inv_final$ISUBST),main="ISUBST")
# ICORE - empty
barplot(table(Inv_final$ICORE),main="ICORE")
# IREPL - empty
barplot(table(Inv_final$IREPL),main="IREPL")
# ISLUM - mostly empty
barplot(table(Inv_final$ISLUM),main="ISLUM")
# IUMCV2 - all 1's
barplot(table(Inv_final$IUMCV2),main="IUMCV2")
# IBYUM - all EA's
barplot(table(Inv_final$IBYUM),main="IBYUM")
# IMINPK
barplot(table(Inv_final$IMINPK),main="IMINPK")
# ISTDPK
barplot(table(Inv_final$ISTDPK),main="ISTDPK")
# IHLDOR - mostly empty
barplot(table(Inv_final$IHLDOR),main="IHLDOR")
# IMOQTY - mostly empty
barplot(table(Inv_final$IMOQTY),main="IMOQTY")
# IMNSTK - empty
barplot(table(Inv_final$IMNSTK),main="IMNSTK")
# IMXSTK
barplot(table(Inv_final$IMXSTK),main="IMXSTK")
# IMDSTK - empty
barplot(table(Inv_final$IMDSTK),main="IMDSTK")
# IDSPLY
barplot(table(Inv_final$IDSPLY),main="IDSPLY")
# IOMULT - mostly empty
barplot(table(Inv_final$IOMULT),main="IOMULT")
# IRPLCD - convert NA's to 0
Inv_final$IRPLCD[is.na(Inv_final$IRPLCD)]<-0
barplot(table(Inv_final$IRPLCD),main="IRPLCD")
# IMFPRC - empty
barplot(table(Inv_final$IMFPRC),main="IMFPRC")
# IWGHT - there is one outlier that throws the significance off
barplot(table(Inv_final$IWGHT),main="IWGHT")
Inv_final$IWGHT[Inv_final$IWGHT==3001.4]=0
# ICUBE - investigate taking the log(ICUBE)
barplot(table(Inv_final$ICUBE),main="ICUBE")
# IDLGTH - investigate taking the log(ICUBE)
barplot(table(Inv_final$IDLGTH),main="IDLGTH")
# IDWDTH - investigate taking the log(ICUBE)
barplot(table(Inv_final$IDWDTH),main="IDWDTH")
# IDHGHT - investigate taking the log(ICUBE)
barplot(table(Inv_final$IDHGHT),main="IDHGHT")
# IMDATE
barplot(table(Inv_final$IMDATE),main="IMDATE")
# IMCENT - empty
barplot(table(Inv_final$IMCENT),main="IMCENT")
# IVPLTI - not significant
barplot(table(Inv_final$IVPLTI),main="IVPLTI")
# IVPLHI
barplot(table(Inv_final$IVPLHI),main="IVPLHI")
# SHPNUM - empty
barplot(table(Inv_final$SHPNUM),main="SHPNUM")

# Lots of NA's in IDISTM, replace with 0
Inv_final$IDISTM[is.na(Inv_final$IDISTM)]<-0
barplot(table(Inv_final$IDISTM),main="IDISTM")

# IHLDWO - empty
barplot(table(Inv_final$IHLDWO),main="IHLDWO")
# IIGNUM - empty
barplot(table(Inv_final$IIGNUM),main="IIGNUM")
# ISDIM - empty
barplot(table(Inv_final$ISDIM),main="ISDIM")
# IVATCD - all NA's
# IPLAN - empty
barplot(table(Inv_final$IPLAN),main="IPLAN")
# IVLRK1 - empty
barplot(table(Inv_final$IVLRK1),main="IVLRK1")
# IVLRK2 - empty
barplot(table(Inv_final$IVLRK2),main="IVLRK2")
# IVLRK3 - all NA's
# IVLRK4 - all NA's
# IRPLCN - empty
barplot(table(Inv_final$IRPLCN),main="IRPLCN")
# IRPLDT - empty
barplot(table(Inv_final$IRPLDT),main="IRPLDT")
# ISEASN
barplot(table(Inv_final$ISEASN),main="ISEASN")
# IDEADC
barplot(table(Inv_final$IDEADC),main="IDEADC")
# IDEADD - empty
barplot(table(Inv_final$IDEADD),main="IDEADD")
# INLRTL
barplot(table(Inv_final$INLRTL),main="INLRTL")
# IHANDL is all NA's
# IATRB1 - empty
barplot(table(Inv_final$IATRB1),main="IATRB1")
# IATRB2 - empty
barplot(table(Inv_final$IATRB2),main="IATRB2")
# IATRB3
barplot(table(Inv_final$IATRB3),main="IATRB3")
# IATRB4 - empty
barplot(table(Inv_final$IATRB4),main="IATRB4")
# IATRB5 - all N's
barplot(table(Inv_final$IATRB5),main="IATRB5")
# IPRCCH
barplot(table(Inv_final$IPRCCH),main="IPRCCH")
# IPRCZN - all N's
barplot(table(Inv_final$IPRCZN),main="IPRCZN")
# IPRCST
barplot(table(Inv_final$IPRCST),main="IPRCST")
# IASNUM - empty
barplot(table(Inv_final$IASNUM),main="IASNUM")
# ICORGP
barplot(table(Inv_final$ICORGP),main="ICORGP")
# ILEAD
barplot(table(Inv_final$ILEAD),main="ILEAD")
# IHZCOD - all NA's
# IFRACT - all NA's
# IMCRDT - distributed
barplot(table(Inv_final$IMCRDT),main="IMCRDT")
# IMCRCN - all 1's
barplot(table(Inv_final$IMCRCN),main="IMCRCN")
```

#Check cross correlation of attributes to eliminate reduncancy

Create corrplot of Inventory Master (we see that ITKTTR, ITKTN and ILBLTR are highly correlated.  ITKTTR, it turns out is not a significant predictor of sales, so it will be removed.  ILBLTR will also be removed due to colinearity.)

```{r, echo=FALSE}
Inv_final_data<-Inv_final[c("ASNUM","IDEPT","ISDEPT","ICLAS","ISCLAS","IMFGNO","BYRNUM","ITKTTR","ITKTN","ILBLTR","IFINLN","ISTYPE","IMINPK","ISTDPK","IMXSTK","IDSPLY","IRPLCD","IWGHT","IVPLHI","IMDATE","IDISTM","ISEASN","INLRTL","IATRB3","IPRCCH","IPRCST","ICORGP","ILEAD","IMCRDT")]
Inv_final_num<-Inv_final_data[sapply(Inv_final_data, is.numeric)]
M<-cor(Inv_final_num)
corrplot(M,"color",title="Co-linearity Test")
```

#Build basis Linear Regression model

Linear Regression model (on Sales and Inventory only).
  R-squared: 0.3234

```{r, echo=FALSE}
model_sales=lm(IBWK01_sum~IBHAND_sum+IBWK02_sum+IBWK03_sum+IBWK04_sum+IBWK05_sum+IBWK06_sum+IBWK07_sum+IBWK08_sum, data=Inv_final)
summary(model_sales)
```

Complete working Linear Regression model (all non-empty attributes).
  R-squared: 0.4574

```{r, echo=FALSE}
model_attrib=lm(IBWK01_sum~IBHAND_sum+IBWK02_sum+IBWK03_sum+IBWK04_sum+IBWK05_sum+IBWK06_sum+IBWK07_sum+IBWK08_sum+ASNUM+IDEPT+ISDEPT+ICLAS+ISCLAS+IMFGNO+BYRNUM+ITKTTR+ITKTN+ILBLTR+IFINLN+ISTYPE+IMINPK+ISTDPK+IMXSTK+IDSPLY+IRPLCD+IWGHT+IVPLHI+IMDATE+IDISTM+ISEASN+INLRTL+IATRB3+IPRCCH+IPRCST+ICORGP+ILEAD+IMCRDT, data=Inv_final)
summary(model_attrib)
```

Add top 50 words to Linear Regression model.
  R-squared: 0.4586

```{r, echo=FALSE}
model_attrib=lm(IBWK01_sum~IBHAND_sum+IBWK02_sum+IBWK03_sum+IBWK04_sum+IBWK05_sum+IBWK06_sum+IBWK07_sum+IBWK08_sum+ASNUM+IDEPT+ISDEPT+ICLAS+ISCLAS+IMFGNO+BYRNUM+ITKTTR+ITKTN+ILBLTR+IFINLN+ISTYPE+IMINPK+ISTDPK+IMXSTK+IDSPLY+IRPLCD+IWGHT+IVPLHI+IMDATE+IDISTM+ISEASN+INLRTL+IATRB3+IPRCCH+IPRCST+ICORGP+ILEAD+IMCRDT+w_babi+w_bag+w_bdi+w_bird+w_birthday+w_black+w_blue+w_box+w_bracelet+w_butterfli+w_cake+w_candl+w_card+w_cardx+w_conv+w_crystal+w_dog+w_dress+w_earring+w_floral+w_flower+w_gem+w_general+w_girl+w_glass+w_glitter+w_gold+w_handmad+w_happi+w_heart+w_love+w_med+w_mini+w_mom+w_neck+w_necklac+w_note+w_pink+w_print+w_red+w_ribbon+w_set+w_silver+w_soap+w_thank+w_tree+w_vintag+w_wed+w_white+w_xbc, data=Inv_final)
summary(model_attrib)
```

Minimal Linear Regression model (all non-empty attributes, removing non-correlated and colinear attributes)
  Attributes removed:
    ISDEPT,
    ITKTTR,
    ILBLTR,
    ISTDPK,
    IWGHT,
    IMDATE,
    ILEAD.
  R-squared: 0.4574

```{r, echo=FALSE}
model_minimal=lm(IBWK01_sum~IBHAND_sum+IBWK02_sum+IBWK03_sum+IBWK04_sum+IBWK05_sum+IBWK06_sum+IBWK07_sum+IBWK08_sum+ASNUM+IDEPT+ICLAS+ISCLAS+IMFGNO+BYRNUM+ITKTN+IFINLN+ISTYPE+IMINPK+IMXSTK+IDSPLY+IRPLCD+IVPLHI+IDISTM+ISEASN+INLRTL+IATRB3+IPRCCH+IPRCST+ICORGP+IMCRDT+w_babi+w_bag+w_bdi+w_bird+w_birthday+w_black+w_blue+w_box+w_bracelet+w_butterfli+w_cake+w_candl+w_card+w_cardx+w_conv+w_crystal+w_dog+w_dress+w_earring+w_floral+w_flower+w_gem+w_general+w_girl+w_glass+w_glitter+w_gold+w_handmad+w_happi+w_heart+w_love+w_med+w_mini+w_mom+w_neck+w_necklac+w_note+w_pink+w_print+w_red+w_ribbon+w_set+w_silver+w_soap+w_thank+w_tree+w_vintag+w_wed+w_white+w_xbc, data=Inv_final)
summary(model_minimal)
```

#Prepare data for model evaluation

Break data set up into Training and Test sets (70-30).

```{r}
set.seed(123)
index<-sample(1:nrow(Inv_final),size=0.7*nrow(Inv_final))

Inv_final_train<-Inv_final[index,]
Inv_final_test<-Inv_final[-index,]
```

Remove factor levels from test set not in training set.

```{r, echo=FALSE}
Inv_final_train$IMFGNO<-Inv_final_train$IMFGNO[,drop=TRUE]
Inv_final_train$IFINLN<-Inv_final_train$IFINLN[,drop=TRUE]
Inv_final_train$ISTYPE<-Inv_final_train$ISTYPE[,drop=TRUE]
Inv_final_train$ICORGP<-Inv_final_train$ICORGP[,drop=TRUE]
Inv_final_train$ISEASN<-Inv_final_train$ISEASN[,drop=TRUE]
Inv_final_train$IATRB3<-Inv_final_train$IATRB3[,drop=TRUE]
Inv_final_train$IPRCCH<-Inv_final_train$IPRCCH[,drop=TRUE]
Inv_final_train$IPRCST<-Inv_final_train$IPRCST[,drop=TRUE]

Inv_final_test$IMFGNO<-Inv_final_test$IMFGNO[,drop=TRUE]
Inv_final_test$IFINLN<-Inv_final_test$IFINLN[,drop=TRUE]
Inv_final_test$ISTYPE<-Inv_final_test$ISTYPE[,drop=TRUE]
Inv_final_test$ICORGP<-Inv_final_test$ICORGP[,drop=TRUE]
Inv_final_test$ISEASN<-Inv_final_test$ISEASN[,drop=TRUE]
Inv_final_test$IATRB3<-Inv_final_test$IATRB3[,drop=TRUE]
Inv_final_test$IPRCCH<-Inv_final_test$IPRCCH[,drop=TRUE]
Inv_final_test$IPRCST<-Inv_final_test$IPRCST[,drop=TRUE]

id <- which(!(Inv_final_test$IMFGNO %in% levels(Inv_final_train$IMFGNO)))
Inv_final_test$IMFGNO[id]<-""

id <- which(!(Inv_final_test$IFINLN %in% levels(Inv_final_train$IFINLN)))
#Inv_final_test$IFINLN[id]<-""

id <- which(!(Inv_final_test$ISTYPE %in% levels(Inv_final_train$ISTYPE)))
Inv_final_test$ISTYPE[id]<-"01"

id <- which(!(Inv_final_test$ICORGP %in% levels(Inv_final_train$ICORGP)))
Inv_final_test$ICORGP[id]<-""

id <- which(!(Inv_final_test$ISEASN %in% levels(Inv_final_train$ISEASN)))
#Inv_final_test$ISEASN[id]<-""

id <- which(!(Inv_final_test$IATRB3 %in% levels(Inv_final_train$IATRB3)))
#Inv_final_test$IATRB3[id]<-""

id <- which(!(Inv_final_test$IPRCCH %in% levels(Inv_final_train$IPRCCH)))
#Inv_final_test$IPRCCH[id]<-""

id <- which(!(Inv_final_test$IPRCST %in% levels(Inv_final_train$IPRCST)))
#Inv_final_test$IPRCST[id]<-""

Inv_final_test$IMFGNO<-Inv_final_test$IMFGNO[,drop=TRUE]
Inv_final_test$IFINLN<-Inv_final_test$IFINLN[,drop=TRUE]
Inv_final_test$ISTYPE<-Inv_final_test$ISTYPE[,drop=TRUE]
Inv_final_test$ICORGP<-Inv_final_test$ICORGP[,drop=TRUE]
Inv_final_test$ISEASN<-Inv_final_test$ISEASN[,drop=TRUE]
Inv_final_test$IATRB3<-Inv_final_test$IATRB3[,drop=TRUE]
Inv_final_test$IPRCCH<-Inv_final_test$IPRCCH[,drop=TRUE]
Inv_final_test$IPRCST<-Inv_final_test$IPRCST[,drop=TRUE]

for (p in names(Inv_final_test)) { 
     if (class(Inv_final_train[[p]]) == "factor") { 
         levels(Inv_final_test[[p]]) <- levels(Inv_final_train[[p]]) 
     } 
}
```

#Create models and evaluate

Calculate Baseline Model

```{r}
best.guess<-mean(Inv_final_train$IBWK01_sum)
RMSE.baseline<-sqrt(mean((best.guess-Inv_final_test$IBWK01_sum)^2))
message('RMSE: ', RMSE.baseline)
MAE.baseline<-mean(abs(best.guess-Inv_final_test$IBWK01_sum))
message('MAE: ', MAE.baseline)
```

Create minimal Linear Regression model on Training Data

```{r, echo=FALSE}
model_lr=lm(IBWK01_sum~IBHAND_sum+IBWK02_sum+IBWK03_sum+IBWK04_sum+IBWK05_sum+IBWK06_sum+IBWK07_sum+IBWK08_sum+ASNUM+IDEPT+ICLAS+ISCLAS+IMFGNO+BYRNUM+ITKTN+IFINLN+ISTYPE+IMINPK+IMXSTK+IDSPLY+IRPLCD+IVPLHI+IDISTM+ISEASN+INLRTL+IATRB3+IPRCCH+IPRCST+ICORGP+IMCRDT+w_babi+w_bag+w_bdi+w_bird+w_birthday+w_black+w_blue+w_box+w_bracelet+w_butterfli+w_cake+w_candl+w_card+w_cardx+w_conv+w_crystal+w_dog+w_dress+w_earring+w_floral+w_flower+w_gem+w_general+w_girl+w_glass+w_glitter+w_gold+w_handmad+w_happi+w_heart+w_love+w_med+w_mini+w_mom+w_neck+w_necklac+w_note+w_pink+w_print+w_red+w_ribbon+w_set+w_silver+w_soap+w_thank+w_tree+w_vintag+w_wed+w_white+w_xbc, data=Inv_final_train)
summary(model_minimal)
```

Calculate errors on LR model

```{r, echo=FALSE}
test.pred.sales.lr<-predict(model_lr,Inv_final_test)
RMSE.lr<-sqrt(mean((test.pred.sales.lr-Inv_final_test$IBWK01_sum)^2))
message('RMSE: ', RMSE.lr)
MAE.lr<-mean(abs(test.pred.sales.lr-Inv_final_test$IBWK01_sum))
message('MAE: ', MAE.lr)
```

Create Decision Tree model

```{r, echo=FALSE}
model_dt=rpart(IBWK01_sum~IBHAND_sum+IBWK02_sum+IBWK03_sum+IBWK04_sum+IBWK05_sum+IBWK06_sum+IBWK07_sum+IBWK08_sum+ASNUM+IDEPT+ICLAS+ISCLAS+IMFGNO+BYRNUM+ITKTN+IFINLN+ISTYPE+IMINPK+IMXSTK+IDSPLY+IRPLCD+IVPLHI+IDISTM+ISEASN+INLRTL+IATRB3+IPRCCH+IPRCST+ICORGP+IMCRDT+w_babi+w_bag+w_bdi+w_bird+w_birthday+w_black+w_blue+w_box+w_bracelet+w_butterfli+w_cake+w_candl+w_card+w_cardx+w_conv+w_crystal+w_dog+w_dress+w_earring+w_floral+w_flower+w_gem+w_general+w_girl+w_glass+w_glitter+w_gold+w_handmad+w_happi+w_heart+w_love+w_med+w_mini+w_mom+w_neck+w_necklac+w_note+w_pink+w_print+w_red+w_ribbon+w_set+w_silver+w_soap+w_thank+w_tree+w_vintag+w_wed+w_white+w_xbc, data=Inv_final_train)
summary(model_dt)
```

Calculate errors on DT model

```{r, echo=FALSE}
test.pred.sales.dt<-predict(model_dt,Inv_final_test)
RMSE.dt<-sqrt(mean((test.pred.sales.dt-Inv_final_test$IBWK01_sum)^2))
message('RMSE: ', RMSE.dt)
MAE.dt<-mean(abs(test.pred.sales.dt-Inv_final_test$IBWK01_sum))
message('MAE: ', MAE.dt)
```

Prune resulting model (had no effect)

```{r, echo=FALSE}
printcp(model_dt)
min.xerror <- model_dt$cptable[which.min(model_dt$cptable[,"xerror"]),"CP"]
model_dt.pruned <- prune(model_dt,cp = min.xerror) 
```

Calculate errors on pruned DT model

```{r, echo=FALSE}
test.pred.sales.dt.p<-predict(model_dt.pruned,Inv_final_test)
RMSE.dt.pruned<-sqrt(mean((test.pred.sales.dt.p-Inv_final_test$IBWK01_sum)^2))
message('RMSE: ', RMSE.dt.pruned)
MAE.dt.pruned<-mean(abs(test.pred.sales.dt.p-Inv_final_test$IBWK01_sum))
message('MAE: ', MAE.dt.pruned)
```

Create Random Forest model

```{r}
model_rf=randomForest(IBWK01_sum~IBHAND_sum+IBWK02_sum+IBWK03_sum+IBWK04_sum+IBWK05_sum+IBWK06_sum+IBWK07_sum+IBWK08_sum+ASNUM+IDEPT+ICLAS+ISCLAS+BYRNUM+ITKTN+IFINLN+ISTYPE+IMINPK+IMXSTK+IDSPLY+IRPLCD+IVPLHI+IDISTM+ISEASN+INLRTL+IATRB3+IPRCCH+IPRCST+ICORGP+IMCRDT+w_babi+w_bag+w_bdi+w_bird+w_birthday+w_black+w_blue+w_box+w_bracelet+w_butterfli+w_cake+w_candl+w_card+w_cardx+w_conv+w_crystal+w_dog+w_dress+w_earring+w_floral+w_flower+w_gem+w_general+w_girl+w_glass+w_glitter+w_gold+w_handmad+w_happi+w_heart+w_love+w_med+w_mini+w_mom+w_neck+w_necklac+w_note+w_pink+w_print+w_red+w_ribbon+w_set+w_silver+w_soap+w_thank+w_tree+w_vintag+w_wed+w_white+w_xbc, data=Inv_final_train,importance=TRUE, ntree=1000)
#summary(model_rf)

message('Minimum MSE tree count:', which.min(model_rf$mse))
imp <- as.data.frame(sort(importance(model_rf)[,1],decreasing = TRUE),optional = T)
names(imp) <- "% Inc MSE"
message('Importance of independent variables:')
imp
```

Calculate errors on RF model

```{r, echo=FALSE}
test.pred.sales.rf<-predict(model_rf,Inv_final_test)
RMSE.rf<-sqrt(mean((test.pred.sales.rf-Inv_final_test$IBWK01_sum)^2))
message('RMSE: ', RMSE.rf)
MAE.rf<-mean(abs(test.pred.sales.rf-Inv_final_test$IBWK01_sum))
message('MAE: ', MAE.rf)
```

#Putting it all together!

```{r, echo=FALSE}
accuracy <- data.frame(Method = c("Baseline","Linear Regression","Full tree","Pruned tree","Random forest"),
            RMSE = c(RMSE.baseline,RMSE.lr,RMSE.dt,RMSE.dt.pruned,RMSE.rf),
            MAE = c(MAE.baseline,MAE.lr,MAE.dt,MAE.dt.pruned,MAE.rf)) 
accuracy$RMSE <- round(accuracy$RMSE,2)
accuracy$MAE <- round(accuracy$MAE,2) 
accuracy

message('First few predictions:')

predictions<-data.frame(Actual=Inv_final_test$IBWK01_sum,
                        Baseline=round(best.guess,2),
                        LinReg=round(test.pred.sales.lr,2),
                        DecTree=round(test.pred.sales.dt,2),
                        DecTreePruned=round(test.pred.sales.dt.p,2),
                        RandForest=round(test.pred.sales.rf,2))
head(predictions)
all.predictions <- gather(predictions,key = model,value = predictions,2:6)

message('Cut off at 10')

ggplot(data = all.predictions,aes(x = Actual, y = predictions)) + 
  geom_point(colour = "blue") + 
  geom_abline(intercept = 0, slope = 1, colour = "red") +
  geom_vline(xintercept = 23, colour = "green", linetype = "dashed") +
  facet_wrap(~ model,ncol = 2) + 
  coord_cartesian(xlim = c(0,10),ylim = c(0,10)) +
  ggtitle("Predicted vs. Actual, by model")
```

#Summary

From RMSE and MAE measurements, it appears that the Decision Tree model is the best.  Looking at the graphs of Predicted vs. Actual, Random Forest looks to push closer to ideal.  More input is needed to get a better prediction of R-squared of 0.46.