---
title: "Item Classifier"
author: "Christopher Himmel"
date: "January 16, 2016"
output: html_document
---

As items are entered into the MMS, many properties are set.  One of these is the hierarchy, which is a set of four number that describes the class of item.
 
Here I am taking the current list of items and determine the correlation of the properties to the hierarchy.  Once this is done, the hierarchy entered for an item can be validated based on the properties entered for the item.
 
An extension of this will use more information for input than just the SKU properties, such as sales of the item.  The validation would be delayed until sales have been generated, but still useful. 
 
Another extension will be to create a model for evaluating other attributes besides hierarchy based on the attributes minus the predicted attribute.. 

Another extension will be to create a model for predicting sales from the SKU attributes.  Outliers could be checked for out of stock, replenishment issues, etc.

Time series models of sales history could also be used to predict, or enhance prediction, of future sales.


The steps first in MMS are:

Download INVMST
Download INVCBL
Download INVBAL - only ISTORE between 1001 and 1003

Get Field Definitions (e.g.):

SELECT 
  COLUMN_NAME, 
  TABLE_NAME, 
  DATA_TYPE, 
  LENGTH, 
  NUMERIC_SCALE,
  COLUMN_TEXT, 
  SYSTEM_TABLE_SCHEMA
FROM
  syscolumns
WHERE
  TABLE_NAME='INVBAL'    


Set up environment:

```{r, echo=FALSE}
#Needed<-c("dplyr", "tm", "wordcloud","SnowballC")
#install.packages(Needed, dependencies=TRUE)
library(tm)
library(dplyr)
library(wordcloud)
library(SnowballC)
setwd("C:/Users/Christopher Himmel/Dropbox/Deep Learning/SlideRule Foundations/Capstone")
```

Load and view Item Master (INVMST).

```{r}
Item_Master = read.csv("INVMST - Item Master.csv")
#View(Item_Master)
#summary(Item_Master)
```

Load and view Chain Level Inventory Balance file (INVCBL).

```{r}
Inv_Bal_Chain = read.csv("INVCBL - Chain Level Inventory Balance Data.csv")
#View(Inv_Bal_Chain)
#summary(Inv_Bal_Chain)
```

Load and view Store Level Inventory Balance file, filtered for Niquea'D stores (INVBAL).

```{r}
Inv_Bal_Store = read.csv("INVBAL - Store Level Inventory Balance Data - Niquea'D.csv")
#View(Inv_Bal_Store)
#summary(Inv_Bal_Store)
```

Create chain level field with combined regular sales and advertised sales.

```{r}
Inv_Bal_Chain_mut <-
	Inv_Bal_Chain %>%
	mutate(chn_sales=CBRSUY+CBASUY)
```

Create total Niquea'D summarized sales with combined regular sales and advertised sales.

```{r}
Inv_Bal_Store_sum <- 
	Inv_Bal_Store %>%
	group_by(INUMBR) %>%
	summarise(nd_sales=sum(IBRSUY+IBASUY))
```

Combine two new sales numbers into one file by SKU.

```{r}
Inv_values <-
	Inv_Bal_Store_sum %>%
	left_join(Inv_Bal_Chain_mut, by="INUMBR") %>%
	select(INUMBR,nd_sales,chn_sales)
```

Combine SKU, sales data into one file for analysis.

```{r}
Inv_final <-
	Inv_values %>%
	left_join(Item_Master, by="INUMBR")
```

Take a look at some summary information.

```{r}
Inv_summary<-summary(Inv_final)
#View(Inv_summary)
#str(Item_Master)
```

Add field for summary of hierarchy fields.

```{r}
Inv_final_mut<-Inv_final %>%
  mutate(hierarchy=IDEPT*1000000000+ISDEPT*1000000+ICLAS*1000+ISCLAS)
```

Extract word list from description

```{r}
word_list <- paste(Inv_final_mut$IDESCR, collapse=" ")
word_list_vector <- VectorSource(word_list)
rm(word_list)
word_list_corpus <- Corpus(word_list_vector)
rm(word_list_vector)

word_list_corpus <- tm_map(word_list_corpus, content_transformer(tolower))
word_list_corpus <- tm_map(word_list_corpus, removePunctuation)
word_list_corpus <- tm_map(word_list_corpus, stripWhitespace)
word_list_corpus <- tm_map(word_list_corpus, removeNumbers)
word_list_corpus <- tm_map(word_list_corpus, removeWords, stopwords("english"))
word_list_corpus <- tm_map(word_list_corpus, stemDocument)

tdm<-TermDocumentMatrix(word_list_corpus)
rm(word_list_corpus)
tdm2<-as.matrix(tdm)
rm(tdm)
tdm3<-as.data.frame(tdm2)
rm(tdm2)
colnames(tdm3)<-c("count")
tdm4<-subset(tdm3,tdm3$count>200)
rm(tdm3)
top_words_list<-rownames(tdm4)
rm(tdm4)
```


Generate training vector

```{r}
description_list <- Inv_final_mut$IDESCR
description_list_vector <- VectorSource(description_list)
rm(description_list)
description_list_corpus <- Corpus(description_list_vector)
rm(description_list_vector)

description_list_corpus <- tm_map(description_list_corpus, content_transformer(tolower))
description_list_corpus <- tm_map(description_list_corpus, removePunctuation)
description_list_corpus <- tm_map(description_list_corpus, stripWhitespace)
description_list_corpus <- tm_map(description_list_corpus, removeNumbers)
description_list_corpus <- tm_map(description_list_corpus, removeWords, stopwords("english"))
description_list_corpus <- tm_map(description_list_corpus, stemDocument)

dtm_training<-DocumentTermMatrix(description_list_corpus)
rm(description_list_corpus)
dtm_training2<-as.matrix(dtm_training)
rm(dtm_training)
dtm_match<-match(top_words_list,colnames(dtm_training2))
dtm_training_top<-dtm_training2[,dtm_match]
rm(dtm_training2)
dtm_training_topdf<-as.data.frame(dtm_training_top)
rm(dtm_training_top)
colnames(dtm_training_topdf)<-paste("w", colnames(dtm_training_topdf), sep="_")
```

Add word values to training set.

```{r}
Inv_final_mut$rownumber<-c(1:nrow(Inv_final_mut))
dtm_training_topdf$rownumber<-rownames(dtm_training_topdf)

Inv_final_mut<-merge(Inv_final_mut,dtm_training_topdf,by="rownumber")
```

Time to investigate each column for significant data

```{r}
# IDESCR - factors of descriptions
# ICHECK - all Zeros
barplot(table(Inv_final_mut$ICHECK))
# IDSCCD - minimal values
barplot(table(Inv_final_mut$IDSCCD))
# ISORT - factors of descriptions
# ISTYLN - all NA's
# ASNUM - distributed values
barplot(table(Inv_final_mut$ASNUM))
# IVNDPN - empty
barplot(table(Inv_final_mut$IVNDPN))
# IMFGR - empty
barplot(table(Inv_final_mut$IMFGR))
# IMFGNO - some values
barplot(table(Inv_final_mut$IMFGNO))
# IDEPT - part of Dependent Variable
barplot(table(Inv_final_mut$IDEPT))
# ISDEPT - part of Dependent Variable
barplot(table(Inv_final_mut$ISDEPT))
# ICLAS - part of Dependent Variable
barplot(table(Inv_final_mut$ICLAS))
# ISCLAS - part of Dependent Variable
barplot(table(Inv_final_mut$ISCLAS))
# BYRNUM
barplot(table(Inv_final_mut$BYRNUM))
# IASPAC - empty
barplot(table(Inv_final_mut$IASPAC))
# IADVYN - empty
barplot(table(Inv_final_mut$IADVYN))
# IBUYCD - mostly empty
barplot(table(Inv_final_mut$IBUYCD))
# ISET - empty
barplot(table(Inv_final_mut$ISET))
# IWARNT - mostly empty
barplot(table(Inv_final_mut$IWARNT))
# IPRMPT - mostly empty
barplot(table(Inv_final_mut$IPRMPT))
# IPRVNT - mostly empty
barplot(table(Inv_final_mut$IPRVNT))
# ITKTTR
barplot(table(Inv_final_mut$ITKTTR))
# ITKTTA - mostly empty
barplot(table(Inv_final_mut$ITKTTA))
# ITKTN
barplot(table(Inv_final_mut$ITKTN))
# ILBLTR
barplot(table(Inv_final_mut$ILBLTR))
# ILBLTA - empty
barplot(table(Inv_final_mut$ILBLTA))
# IFINLN
barplot(table(Inv_final_mut$IFINLN))
# IPROFL - mostly empty
barplot(table(Inv_final_mut$IPROFL))
# IMODUL - mostly empty
barplot(table(Inv_final_mut$IMODUL))
# ISTYPE
barplot(table(Inv_final_mut$ISTYPE))
# ISCOLR - mostly empty
barplot(table(Inv_final_mut$ISCOLR))
# ISSIZE - mostly empty
barplot(table(Inv_final_mut$ISSIZE))
# IHAZCD - all NA's
# MCHNUM - all NA's
# ISUBST - empty
barplot(table(Inv_final_mut$ISUBST))
# ICORE - empty
barplot(table(Inv_final_mut$ICORE))
# IREPL - empty
barplot(table(Inv_final_mut$IREPL))
# ISLUM - mostly empty
barplot(table(Inv_final_mut$ISLUM))
# IUMCV2 - all 1's
barplot(table(Inv_final_mut$IUMCV2))
# IBYUM - all EA's
barplot(table(Inv_final_mut$IBYUM))
# IMINPK
barplot(table(Inv_final_mut$IMINPK))
# ISTDPK
barplot(table(Inv_final_mut$ISTDPK))
# IHLDOR - mostly empty
barplot(table(Inv_final_mut$IHLDOR))
# IMOQTY - mostly empty
barplot(table(Inv_final_mut$IMOQTY))
# IMNSTK - empty
barplot(table(Inv_final_mut$IMNSTK))
# IMXSTK
barplot(table(Inv_final_mut$IMXSTK))
# IMDSTK - empty
barplot(table(Inv_final_mut$IMDSTK))
# IDSPLY
barplot(table(Inv_final_mut$IDSPLY))
# IOMULT - mostly empty
barplot(table(Inv_final_mut$IOMULT))
# IRPLCD
barplot(table(Inv_final_mut$IRPLCD))
# IMFPRC - empty
barplot(table(Inv_final_mut$IMFPRC))
# IWGHT - there is one outlier that throws the significance off
barplot(table(Inv_final_mut$IWGHT))
Inv_final_mut$IWGHT[Inv_final_mut$IWGHT==3001.4]=0
# ICUBE - investigate taking the log(ICUBE)
barplot(table(Inv_final_mut$ICUBE))
# IDLGTH - investigate taking the log(ICUBE)
barplot(table(Inv_final_mut$IDLGTH))
# IDWDTH - investigate taking the log(ICUBE)
barplot(table(Inv_final_mut$IDWDTH))
# IDHGHT - investigate taking the log(ICUBE)
barplot(table(Inv_final_mut$IDHGHT))
# IMDATE
barplot(table(Inv_final_mut$IMDATE))
# IMCENT - empty
barplot(table(Inv_final_mut$IMCENT))
# IVPLTI - not significant
barplot(table(Inv_final_mut$IVPLTI))
# IVPLHI
barplot(table(Inv_final_mut$IVPLHI))
# SHPNUM - empty
barplot(table(Inv_final_mut$SHPNUM))

# Lots of NA's in IDISTM, replace with 0
Inv_final_mut$IDISTM[is.na(Inv_final_mut$IDISTM)]<-0
barplot(table(Inv_final_mut$IDISTM))

# IHLDWO - empty
barplot(table(Inv_final_mut$IHLDWO))
# IIGNUM - empty
barplot(table(Inv_final_mut$IIGNUM))
# ISDIM - empty
barplot(table(Inv_final_mut$ISDIM))
# IVATCD - all NA's
# IPLAN - empty
barplot(table(Inv_final_mut$IPLAN))
# IVLRK1 - empty
barplot(table(Inv_final_mut$IVLRK1))
# IVLRK2 - empty
barplot(table(Inv_final_mut$IVLRK2))
# IVLRK3 - all NA's
# IVLRK4 - all NA's
# IRPLCN - empty
barplot(table(Inv_final_mut$IRPLCN))
# IRPLDT - empty
barplot(table(Inv_final_mut$IRPLDT))
# ISEASN
barplot(table(Inv_final_mut$ISEASN))
# IDEADC
barplot(table(Inv_final_mut$IDEADC))
# IDEADD - empty
barplot(table(Inv_final_mut$IDEADD))
# INLRTL
barplot(table(Inv_final_mut$INLRTL))
# IHANDL is all NA's
# IATRB1 - empty
barplot(table(Inv_final_mut$IATRB1))
# IATRB2 - empty
barplot(table(Inv_final_mut$IATRB2))
# IATRB3
barplot(table(Inv_final_mut$IATRB3))
# IATRB4 - empty
barplot(table(Inv_final_mut$IATRB4))
# IATRB5 - all N's
barplot(table(Inv_final_mut$IATRB5))
# IPRCCH
barplot(table(Inv_final_mut$IPRCCH))
# IPRCZN - all N's
barplot(table(Inv_final_mut$IPRCZN))
# IPRCST
barplot(table(Inv_final_mut$IPRCST))
# IASNUM - empty
barplot(table(Inv_final_mut$IASNUM))
# ICORGP
barplot(table(Inv_final_mut$ICORGP))
# ILEAD
barplot(table(Inv_final_mut$ILEAD))
# IHZCOD - all NA's
# IFRACT - all NA's
# IMCRDT - distributed
barplot(table(Inv_final_mut$IMCRDT))
# IMCRCN - all 1's
barplot(table(Inv_final_mut$IMCRCN))
```

Complete working Linear Regression model (all non-empty attributes, without IATRB1).
  R-squared: 0.8282

```{r, echo=FALSE}
model_attrib=lm(hierarchy ~ IDSCCD+ASNUM+IMFGNO+BYRNUM+ITKTTR+ITKTN+ILBLTR+IFINLN+ISTYPE+IMINPK+ISTDPK+IMXSTK+IDSPLY+IRPLCD+IWGHT+IVPLHI+IMDATE+IDISTM+ISEASN+INLRTL+IATRB3+IPRCCH+IPRCST+ICORGP+ILEAD+IMCRDT, data=Inv_final_mut)
summary(model_attrib)
```

Add top 50 words to Linear Regression model.
  R-squared: 0.8368

```{r, echo=FALSE}
model_attrib=lm(hierarchy ~ IDSCCD+ASNUM+IMFGNO+BYRNUM+ITKTTR+ITKTN+ILBLTR+IFINLN+ISTYPE+IMINPK+ISTDPK+IMXSTK+IDSPLY+IRPLCD+IWGHT+IVPLHI+IMDATE+IDISTM+ISEASN+INLRTL+IATRB3+IPRCCH+IPRCST+ICORGP+ILEAD+IMCRDT+w_babi+w_bag+w_bdi+w_bird+w_birthday+w_black+w_blk+w_blue+w_box+w_bracelet+w_butterfli+w_cake+w_candl+w_card+w_charm+w_crystal+w_dog+w_dress+w_earring+w_floral+w_flower+w_gem+w_general+w_girl+w_glass+w_glitter+w_gold+w_handmad+w_happi+w_heart+w_love+w_med+w_mini+w_mom+w_neck+w_necklac+w_note+w_owl+w_pink+w_red+w_ribbon+w_ring+w_santa+w_set+w_silver+w_soap+w_tree+w_wed+w_white+w_xbc, data=Inv_final_mut)
summary(model_attrib)
```

Best working Linear Regression model (all non-empty attributes, without IATRB1, with sales):
  R-squared: 0.8368

```{r, echo=FALSE}
model_all=lm(hierarchy ~ nd_sales+chn_sales+IDSCCD+ASNUM+IMFGNO+BYRNUM+ITKTTR+ITKTN+ILBLTR+IFINLN+ISTYPE+IMINPK+ISTDPK+IMXSTK+IDSPLY+IRPLCD+IWGHT+IVPLHI+IMDATE+IDISTM+ISEASN+INLRTL+IATRB3+IPRCCH+IPRCST+ICORGP+ILEAD+IMCRDT+w_babi+w_bag+w_bdi+w_bird+w_birthday+w_black+w_blk+w_blue+w_box+w_bracelet+w_butterfli+w_cake+w_candl+w_card+w_charm+w_crystal+w_dog+w_dress+w_earring+w_floral+w_flower+w_gem+w_general+w_girl+w_glass+w_glitter+w_gold+w_handmad+w_happi+w_heart+w_love+w_med+w_mini+w_mom+w_neck+w_necklac+w_note+w_owl+w_pink+w_red+w_ribbon+w_ring+w_santa+w_set+w_silver+w_soap+w_tree+w_wed+w_white+w_xbc, data=Inv_final_mut)
summary(model_all)
```

Minimal Linear Regression model (all non-empty attributes, removing non-correlated attributes)
  Attributes removed:
    ITKTTR
    ITKTN
    ILBLTR
    INLRTL
    IMCRDT
  R-squared: 0.8358

```{r, echo=FALSE}
model_minimal=lm(hierarchy ~ nd_sales+chn_sales+IDSCCD+ASNUM+IMFGNO+BYRNUM+IFINLN+ISTYPE+IMINPK+ISTDPK+IMXSTK+IDSPLY+IRPLCD+IWGHT+IVPLHI+IMDATE+IDISTM+ISEASN+IATRB3+IPRCCH+IPRCST+ICORGP+ILEAD+w_babi+w_bag+w_bdi+w_bird+w_birthday+w_black+w_blk+w_blue+w_box+w_bracelet+w_butterfli+w_cake+w_candl+w_card+w_charm+w_crystal+w_dog+w_dress+w_earring+w_floral+w_flower+w_gem+w_general+w_girl+w_glass+w_glitter+w_gold+w_handmad+w_happi+w_heart+w_love+w_med+w_mini+w_mom+w_neck+w_necklac+w_note+w_owl+w_pink+w_red+w_ribbon+w_ring+w_santa+w_set+w_silver+w_soap+w_tree+w_wed+w_white+w_xbc, data=Inv_final_mut)
summary(model_minimal)
```
